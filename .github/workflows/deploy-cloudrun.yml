name: Deploy Backend to Cloud Run

on:
  push:
    branches: [main]
    paths:
      - "api/**"
      - "models/**"
      - ".github/workflows/deploy-cloudrun.yml"
      - ".dockerignore"
  workflow_dispatch:
    inputs:
      gcp_region:
        description: "GCP region for Cloud Run (e.g. us-east1)"
        required: false
        default: "us-east1"
      cloud_run_service:
        description: "Cloud Run service name (defaults to GitHub repo name)"
        required: false
      artifact_repository:
        description: "Artifact Registry repo name (defaults to <service>-repo)"
        required: false

permissions:
  contents: read
  # id-token is only required for Workload Identity Federation (OIDC)
  # Keep it off when using a service account key JSON.

env:
  # No GitHub Variables required.
  # - Project ID is inferred from the service account key JSON.
  # - Service/repository are derived unless provided as workflow_dispatch inputs.
  GCP_PROJECT_ID: ""
  GCP_REGION: ${{ github.event.inputs.gcp_region || 'us-east1' }}
  CLOUD_RUN_SERVICE: ${{ github.event.inputs.cloud_run_service || '' }}
  ARTIFACT_REPOSITORY: ${{ github.event.inputs.artifact_repository || '' }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Derive deployment settings
        shell: bash
        env:
          SA_KEY_JSON: ${{ secrets.GCP_SA_KEY }}
        run: |
          set -euo pipefail

          sanitize_gcp_name() {
            # GCP (Cloud Run service / Artifact Registry repo) naming:
            # - lowercase letters, numbers, hyphens
            # - start with a letter
            # - end with a letter or number
            local raw="$1"
            local s
            s="$(echo "$raw" | tr '[:upper:]' '[:lower:]')"
            s="$(echo "$s" | sed -E 's/[^a-z0-9-]+/-/g')"
            s="$(echo "$s" | sed -E 's/^-+//; s/-+$//')"
            # Ensure starts with a letter
            s="$(echo "$s" | sed -E 's/^[^a-z]+//')"
            # Ensure ends with alnum
            s="$(echo "$s" | sed -E 's/[^a-z0-9]+$//')"
            if [ -z "$s" ]; then
              s="app"
            fi
            echo "$s"
          }

          GCP_PROJECT_ID="$(echo "$SA_KEY_JSON" | jq -r '.project_id')"

          if [ -z "${CLOUD_RUN_SERVICE:-}" ]; then
            # github.repository is "owner/name"; we want "name"
            CLOUD_RUN_SERVICE="${GITHUB_REPOSITORY##*/}"
          fi

          CLOUD_RUN_SERVICE="$(sanitize_gcp_name "$CLOUD_RUN_SERVICE")"

          if [ -z "${ARTIFACT_REPOSITORY:-}" ]; then
            ARTIFACT_REPOSITORY="${CLOUD_RUN_SERVICE}-repo"
          fi

          ARTIFACT_REPOSITORY="$(sanitize_gcp_name "$ARTIFACT_REPOSITORY")"

          if [ -z "${GCP_PROJECT_ID:-}" ] || [ "$GCP_PROJECT_ID" = "null" ]; then
            echo "::error::Could not determine GCP_PROJECT_ID from GCP_SA_KEY (expected JSON field: project_id)"
            exit 1
          fi

          echo "GCP_PROJECT_ID=$GCP_PROJECT_ID" >> "$GITHUB_ENV"
          echo "CLOUD_RUN_SERVICE=$CLOUD_RUN_SERVICE" >> "$GITHUB_ENV"
          echo "ARTIFACT_REPOSITORY=$ARTIFACT_REPOSITORY" >> "$GITHUB_ENV"

          echo "Using project=${GCP_PROJECT_ID}, region=${GCP_REGION}, service=${CLOUD_RUN_SERVICE}, repo=${ARTIFACT_REPOSITORY}"

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Enable required Google Cloud APIs
        shell: bash
        run: |
          set -euo pipefail
          # These are required for pushing to Artifact Registry and deploying to Cloud Run.
          # NOTE: This will fail unless the service account has permission to enable services
          # (e.g. roles/serviceusage.serviceUsageAdmin).
          gcloud services enable \
            artifactregistry.googleapis.com \
            run.googleapis.com \
            --quiet \
          || {
            echo "::error::Failed to enable required APIs. Enable them manually in GCP Console (APIs & Services) or grant the deploy service account 'Service Usage Admin'."
            exit 1
          }

      - name: Ensure Artifact Registry repository exists
        shell: bash
        run: |
          set -euo pipefail
          if gcloud artifacts repositories describe "${ARTIFACT_REPOSITORY}" --location "${GCP_REGION}" >/dev/null 2>&1; then
            echo "Artifact Registry repo exists: ${ARTIFACT_REPOSITORY}"
          else
            echo "Creating Artifact Registry repo: ${ARTIFACT_REPOSITORY}"
            gcloud artifacts repositories create "${ARTIFACT_REPOSITORY}" \
              --repository-format=docker \
              --location "${GCP_REGION}" \
              --description "Docker images for ${CLOUD_RUN_SERVICE}"
          fi

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push image
        env:
          IMAGE: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPOSITORY }}/${{ env.CLOUD_RUN_SERVICE }}:${{ github.sha }}
        run: |
          docker build -f api/Dockerfile -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Deploy to Cloud Run
        env:
          IMAGE: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPOSITORY }}/${{ env.CLOUD_RUN_SERVICE }}:${{ github.sha }}
        run: |
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE }}" \
            --image "$IMAGE" \
            --region "${{ env.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --memory 2Gi \
            --cpu 1 \
            --timeout 300
